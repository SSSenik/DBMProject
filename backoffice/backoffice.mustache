const express = require('express');
const router = express.Router();
const { presentationModeToHtmlString, columnConstraintToHtmlAttrs, schemaTypeToInputType } = require(__basedir + '/utils/utils.js');

const menuItems = [
    {{#schemas}}
    { href: '/backoffice/{{title}}', name: '{{title}}' },
    {{/schemas}}
];

{{#schemas}}
const {{title}} = require(__basedir + '/Models/{{title}}.js');
const {{title}}Schema = require(__basedir + '/schemas/Schema-{{title}}.json');
router.get('/{{title}}', function (req, res) {
    {{title}}.all((rows) => {
        res.render('list', {
            title: '{{title}}',
            schemas: menuItems,
            columns: Object.keys(new {{title}}()).map((col) => {{title}}Schema.properties[col].label),
            rows: rows.map((r) => ({
                rowId: '{{title}}_' + r.id,
                properties: Object.keys(r).map((key) => r[key]),
                actions: [
                    {
                        link: './{{title}}/Details/' + r.id,
                        image: { src: '../../images/read.png', alt: 'read' },
                        tooltip: 'Details',
                    },
                    {
                        link: './{{title}}/Edit/' + r.id,
                        image: { src: '../../images/edit.png', alt: 'edit' },
                        tooltip: 'Edit',
                    },
                    {
                        link: '#',
                        image: {
                            src: '../../images/delete.png',
                            alt: 'delete',
                        },
                        tooltip: 'Delete',
                        events: [
                            {
                                name: 'onclick',
                                function: 'remove',
                                args: r.id,
                            },
                        ],
                    },
                ],
            })),
        });
    });
});

router.get('/{{title}}/Details/:id', function (req, res) {
    {{title}}.get(req.params.id, function (row) {
        res.render('details', {
            title: '{{title}}',
            schemas: menuItems,
            properties: Object.getOwnPropertyNames(row)
                .filter((prop) => {{title}}Schema.properties.hasOwnProperty(prop))
                .map((prop) => ({
                    name: prop,
                    value: row[prop],
                    label: {{title}}Schema.properties[prop].label,
                    htmlString: presentationModeToHtmlString({{title}}Schema.properties[prop].presentationMode, row[prop])
                })),
            references: Object.getOwnPropertyNames(row)
                .filter((prop) =>
                    {{title}}Schema.references.find(
                        (ref) => `${ref.model}_id`.toLowerCase() === prop
                    )
                )
                .map((prop) =>
                    {{title}}Schema.references.find(
                        (ref) => `${ref.model}_id`.toLowerCase() === prop
                    )
                )
                .map((ref) => ({
                    label: ref.label,
                    model: ref.model,
                    values:
                        ref.relation === 'M-M'
                            ? '{{title}}/' + req.params.id
                            : row[(ref.model + '_id').toLowerCase()],
                    isManyToMany: ref.relation === 'M-M',
                })),
            get hasReferences() {
                return this.references.length > 0;
            },
        });
    });
});

router.get('/{{title}}/Insert', function (req, res) {
    res.render('insert', {
        title: '{{title}}',
        schemas: menuItems,
        properties: Object.getOwnPropertyNames(new {{title}}())
            .filter((prop) => {{title}}Schema.properties.hasOwnProperty(prop))
            .map((prop) => ({
                type: schemaTypeToInputType(
                    {{title}}Schema.properties[prop].type
                ),
                isCheckbox: schemaTypeToInputType(
                    {{title}}Schema.properties[prop].type
                ) === 'checkbox',
                required: {{title}}Schema.required.includes(prop),
                attrs: columnConstraintToHtmlAttrs({{title}}Schema.properties[prop]),
                name: prop,
                label: {{title}}Schema.properties[prop].label,
            })),
        references: {{title}}Schema.references.map((ref) => ({
            name: `${ref.model}_id`.toLowerCase(),
            label: ref.label,
            model: ref.model,
            isManyToMany: ref.relation === 'M-M',
        })),
        get hasReferences() {
            return this.references.length > 0;
        },
    });
});

router.get('/{{title}}/Edit/:id', function (req, res) {
    {{title}}.get(req.params.id, function (row) {
        res.render('edit', {
            title: '{{title}}',
            schemas: menuItems,
            id: req.params.id,
            properties: Object.getOwnPropertyNames(row)
                .filter((prop) => {{title}}Schema.properties.hasOwnProperty(prop))
                .map((prop) => ({
                    type: schemaTypeToInputType(
                        {{title}}Schema.properties[prop].type
                    ),
                    isCheckbox: schemaTypeToInputType(
                        {{title}}Schema.properties[prop].type
                    ) === 'checkbox',
                    required: {{title}}Schema.required.includes(prop),
                    attrs: columnConstraintToHtmlAttrs(
                        {{title}}Schema.properties[prop]
                    ),
                    name: prop,
                    value: row[prop],
                    label: {{title}}Schema.properties[prop].label,
                })),
            references: Object.getOwnPropertyNames(row)
                .filter((prop) =>
                    {{title}}Schema.references.find(
                        (ref) => `${ref.model}_id`.toLowerCase() === prop
                    )
                )
                .map((prop) =>
                    {{title}}Schema.references.find(
                        (ref) => `${ref.model}_id`.toLowerCase() === prop
                    )
                )
                .map((ref) => ({
                    name: `${ref.model}_id`.toLowerCase(),
                    label: ref.label,
                    model: ref.model,
                    values:
                        ref.relation === 'M-M'
                            ? '{{title}}/' + req.params.id
                            : row[(ref.model + '_id').toLowerCase()],
                    isManyToMany: ref.relation === 'M-M',
                })),
            get hasReferences() {
                return this.references.length > 0;
            },
        });
    });
});

{{/schemas}}
module.exports = router;